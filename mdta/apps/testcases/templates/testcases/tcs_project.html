{% extends 'core/base.html' %}

{% block title %}TestCases of Project{% endblock %}

{% block body %}
    <div class="container">
        <div class="row">
            <div class="col-xs-8">
                <div class="row">
                    <div class="col-xs-9">
                        <legend>{{ project.name }} TestCases</legend>
                    </div>
                    <div class="col-xs-3 text-right">
                        <a href="#" class="btn btn-success" id="publish">Publish</a>
                        <a href="{% url 'runner:dashboard' %}" class="btn btn-default">Execution</a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12 progress">
                        <div class="status"></div>
                            <div class="progress">
                                <div class="bar"></div>
                            </div>
                    </div>
                </div>
                <div class="row" id="project-testcases">
                    {% for item in testcases %}
                        {% if item.data %}
                            <div id="{{ item.module }}">
                                <h4>Module: {{ item.module }}</h4>
                                {% for each_tc in item.data %}
                                    {{ forloop.counter }}. {{ each_tc.title }}: <br>
                                    {% if each_tc.tcs_cannot_route %}
                                        <ul>
                                            <li>Status:</li>
                                            {{ each_tc.tcs_cannot_route }}
                                        </ul>
                                    {% else %}
                                        <ul>
                                            <li>PreConditions:</li>
                                            {{ each_tc.pre_conditions }}
                                            <li>Steps:</li>
                                            <ul>
                                                {% for step in each_tc.tc_steps %}
                                                    <li>{{ forloop.counter }}, {{ step }}</li>
                                                {% endfor %}
                                            </ul>
                                        </ul>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="row" id="project-testrail">
                    <legend>TestRail</legend>
                    {% for key, value in testrail.items %}
                        <li>{{ key }}: {{ value }}</li>
                    {% endfor %}
                </div>

            </div>

            <div class="col-xs-4">
                <div class="col-xs-12" id="project-{{ project.id }}">
                    <div class="row">
                        <h4>{{ project.name }} modules list:</h4>
                    </div>
                    <div class="row">
                        <div class="col-xs-12">
                            <ul>
                                {% for module in project.modules %}
                                    <li>
                                        <a href="#{{ module.name }}">{{ module.name }}</a>
                                        {% if user.is_staff %}
                                            <a href="{% url 'testcases:create_testcases' module.id %}?level=module" title="Create TCs"><i class="fa fa-hourglass-2 fa-fw"></i></a>
                                            <span class="tc_loading" hidden>Loading...</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                        </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block footer %}
    <script>
        var button_publish = $('#publish');
        button_publish.click(function(){
            $.ajax("{% url 'graphs:project_publish' project.id %}", {
                type: "GET",
                success: function(data){
                    button_publish.addClass('disabled');
                }
            });
        });

        check_celery_task_state();

        window.setInterval(function(){
            check_celery_task_state();
        }, 5000);

        function check_celery_task_state(){
            var previouse_disabled = button_publish.is('.disabled');

            $.getJSON('{% url 'testcases:check_celery_task_state' %}', function(task_run){
                if (task_run == false){
                    if (previouse_disabled == true){
                        location.reload();
                    }
            $.getJSON('{% url 'testcases:check_celery_task_state' %}', function(data){
                console.log(data);
                if (data.task_run === false){
                    button_publish.removeClass('disabled');
                } else {
                    if (previouse_disabled == false) {
                        button_publish.addClass('disabled')
                    }
                    button_publish.addClass('disabled');
                }
                if (data.task_result.process_percent === null || data.task_result.process_percent === undefined) {
                    $('.bar').css({'width': 0 + '%'});
                } else {
                    $('.bar').css({'width': data.task_result.process_percent + '%'});
                    $('.bar').html(data.task_result.process_percent + '%');
                }
            })
        }

        $('.fa-hourglass-2').click(function(){
            $(this).removeClass('fa-hourglass-2').addClass('fa-spinner fa-pulse fa-2x');

            $(this).closest('li').find('.tc_loading').show();
        });
    </script>
{% endblock %}